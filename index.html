<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>动态攀岩墙布局工具 (带本地存储)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
        }
        .wall-background {
            background-color: #d2b48c; /* Wood color */
            background-image:
                linear-gradient(90deg, rgba(255,255,255,.07) 50%, transparent 50%),
                linear-gradient(90deg, rgba(255,255,255,.13) 50%, transparent 50%);
            background-size: 13px, 29px;
            padding: 12px; /* Simulate 3-inch border */
        }
        .tnut {
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 50%;
            width: 8px;
            height: 8px;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.5);
        }
        .hold {
            width: 90%;
            height: 90%;
            border-radius: 50%;
            box-shadow: 0 5px 8px rgba(0, 0, 0, 0.25), inset 0 2px 4px rgba(255, 255, 255, 0.2);
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .hold:hover {
            transform: scale(1.1);
        }
        textarea {
            font-family: monospace;
        }
        .grid-rows-15 {
            grid-template-rows: repeat(15, minmax(0, 1fr));
        }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">

    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- Left control panel -->
        <div class="lg:col-span-1 bg-white rounded-xl shadow-lg p-6 h-fit">
            <h1 class="text-2xl font-bold text-gray-800">路线控制器</h1>
            <p class="text-gray-500 mt-1 mb-6">管理和切换您的攀岩墙布局</p>

            <!-- Saved Layouts Section -->
            <div class="mb-6">
                <label for="saved-layouts-dropdown" class="block text-lg font-bold text-gray-800 mb-2">历史布局</label>
                <div class="flex space-x-2">
                    <select id="saved-layouts-dropdown" class="block w-full p-2 border border-gray-300 rounded-md bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></select>
                    <button id="delete-layout-btn" title="删除选中的布局" class="p-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    </button>
                </div>
            </div>

            <div id="route-selector" class="space-y-3 mb-6">
                <!-- Route toggle buttons will be generated here -->
            </div>
            
            <div id="route-details" class="space-y-4">
                <!-- Coordinates of selected routes will be shown here -->
            </div>

            <hr class="my-6">

            <div>
                <h2 class="text-xl font-bold text-gray-800">布局编辑器</h2>
                <p class="text-gray-500 mt-1 mb-3 text-sm">在此处编辑路线数据，然后更新或保存。</p>
                <textarea id="json-input" class="w-full h-48 p-2 border border-gray-300 rounded-md bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                <div class="grid grid-cols-2 gap-3 mt-3">
                    <button id="update-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                        更新预览
                    </button>
                    <button id="save-btn" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
                        保存布局
                    </button>
                </div>
                <p id="error-message" class="text-red-500 text-sm mt-2"></p>
            </div>
        </div>

        <!-- Right climbing wall -->
        <div class="lg:col-span-2 bg-white rounded-xl shadow-lg p-4">
            <div id="wall-container" class="relative mx-auto" style="aspect-ratio: 48 / 90; max-width: 500px;">
                <div id="col-labels" class="absolute -top-6 left-0 right-0 grid grid-cols-8 text-center font-bold text-gray-700 text-sm" style="padding-left: 12px; padding-right: 12px;"></div>
                <div id="row-labels" class="absolute -left-6 top-0 bottom-0 flex flex-col-reverse text-center font-bold text-gray-700 text-sm" style="padding-top: 12px; padding-bottom: 12px;"></div>
                
                <div class="wall-background w-full h-full rounded-lg border-2 border-gray-800">
                    <div id="climbing-wall" class="w-full h-full grid grid-cols-8 grid-rows-15">
                        <!-- Grid cells will be generated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const wall = document.getElementById('climbing-wall');
            const routeSelector = document.getElementById('route-selector');
            const routeDetails = document.getElementById('route-details');
            const jsonInput = document.getElementById('json-input');
            const updateBtn = document.getElementById('update-btn');
            const saveBtn = document.getElementById('save-btn');
            const deleteLayoutBtn = document.getElementById('delete-layout-btn');
            const savedLayoutsDropdown = document.getElementById('saved-layouts-dropdown');
            const errorMessage = document.getElementById('error-message');

            // Constants
            const WALL_WIDTH = 8;
            const WALL_HEIGHT = 15;
            const LAYOUTS_STORAGE_KEY = 'climbingWallLayouts';
            const LAST_VIEWED_KEY = 'climbingWallLastViewed';

            // App State
            let routeData = [];
            let activeRoutes = new Set();

            const initialJsonData = `[
              {
                "routeName": "小兔子坡 (Bunny Slope)",
                "targetAge": "1.5岁+",
                "color": "#F59E0B",
                "holds": ["B2", "B5", "B8", "B11", "C3", "C6", "C9", "D2", "D5", "D8", "D12", "E4", "E7", "E10"]
              },
              {
                "routeName": "小狐狸小径 (Fox Trail)",
                "targetAge": "4岁+",
                "color": "#3B82F6",
                "holds": ["A3", "A7", "A12", "C5", "C10", "C14", "E2", "E8", "E13", "F6", "F11", "G4", "G9", "G15", "H14"]
              }
            ]`;

            // --- Local Storage Functions ---
            const getSavedLayouts = () => {
                return JSON.parse(localStorage.getItem(LAYOUTS_STORAGE_KEY)) || {};
            };

            const saveLayouts = (layouts) => {
                localStorage.setItem(LAYOUTS_STORAGE_KEY, JSON.stringify(layouts));
            };

            const populateLayoutsDropdown = () => {
                const layouts = getSavedLayouts();
                savedLayoutsDropdown.innerHTML = '<option value="">-- 读取历史布局 --</option>';
                for (const name in layouts) {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    savedLayoutsDropdown.appendChild(option);
                }
            };

            const handleSaveLayout = () => {
                const layoutName = prompt("请输入布局名称：", `我的新设计 ${Object.keys(getSavedLayouts()).length + 1}`);
                if (layoutName) {
                    const layouts = getSavedLayouts();
                    layouts[layoutName] = jsonInput.value;
                    saveLayouts(layouts);
                    populateLayoutsDropdown();
                    savedLayoutsDropdown.value = layoutName;
                    alert(`布局 "${layoutName}" 已保存！`);
                }
            };

            const handleDeleteLayout = () => {
                const layoutName = savedLayoutsDropdown.value;
                if (!layoutName) {
                    alert("请先从下拉菜单中选择一个布局来删除。");
                    return;
                }
                if (confirm(`您确定要删除布局 "${layoutName}" 吗？此操作无法撤销。`)) {
                    const layouts = getSavedLayouts();
                    delete layouts[layoutName];
                    saveLayouts(layouts);
                    populateLayoutsDropdown();
                    alert(`布局 "${layoutName}" 已删除。`);
                }
            };

            // --- Core Application Logic ---
            function parseCoord(coord) {
                if (typeof coord !== 'string' || coord.length < 2) return null;
                const col = coord.toUpperCase().charCodeAt(0) - 'A'.charCodeAt(0);
                const row = parseInt(coord.substring(1)) - 1;
                if (isNaN(row) || col < 0 || col >= WALL_WIDTH || row < 0 || row >= WALL_HEIGHT) return null;
                return { col, row };
            }
            
            function renderWall() {
                wall.innerHTML = '';
                const gridMap = new Map();
                routeData.forEach((route, index) => {
                    if (activeRoutes.has(index)) {
                        route.holds.forEach(coordStr => {
                            const pos = parseCoord(coordStr);
                            if (pos) {
                                gridMap.set(`${pos.col},${pos.row}`, { color: route.color });
                            }
                        });
                    }
                });

                for (let i = WALL_HEIGHT - 1; i >= 0; i--) {
                    for (let j = 0; j < WALL_WIDTH; j++) {
                        const cell = document.createElement('div');
                        cell.className = 'w-full h-full flex items-center justify-center';
                        const key = `${j},${i}`;
                        const holdData = gridMap.get(key);
                        if (holdData) {
                            const holdEl = document.createElement('div');
                            holdEl.className = 'hold';
                            holdEl.style.backgroundColor = holdData.color;
                            cell.appendChild(holdEl);
                        } else {
                            const tnutEl = document.createElement('div');
                            tnutEl.className = 'tnut';
                            cell.appendChild(tnutEl);
                        }
                        wall.appendChild(cell);
                    }
                }
            }

            function renderControls() {
                routeSelector.innerHTML = '';
                routeData.forEach((route, index) => {
                    const button = document.createElement('button');
                    const isActive = activeRoutes.has(index);
                    button.className = `w-full text-left p-3 rounded-lg border-2 transition-all ${isActive ? 'font-bold text-white' : 'bg-gray-100 hover:bg-gray-200'}`;
                    button.style.backgroundColor = isActive ? route.color : '';
                    button.style.borderColor = route.color;
                    
                    button.innerHTML = `
                        <div class="flex items-center">
                           <div class="w-4 h-4 rounded-full mr-3" style="background-color: ${route.color}; border: 1px solid rgba(0,0,0,0.2)"></div>
                           <div>
                                <div>${route.routeName}</div>
                                <div class="text-xs opacity-80">${route.targetAge}</div>
                           </div>
                        </div>
                    `;
                    button.onclick = () => {
                        if (activeRoutes.has(index)) {
                            activeRoutes.delete(index);
                        } else {
                            activeRoutes.add(index);
                        }
                        updateUI();
                    };
                    routeSelector.appendChild(button);
                });
            }
            
            function renderDetails() {
                routeDetails.innerHTML = '';
                 routeData.forEach((route, index) => {
                    if (activeRoutes.has(index)) {
                        const detailDiv = document.createElement('div');
                        detailDiv.className = 'p-3 rounded-lg border';
                        detailDiv.style.borderColor = route.color;
                        detailDiv.innerHTML = `
                            <h3 class="font-bold text-lg" style="color: ${route.color}">${route.routeName} 坐标</h3>
                            <p class="text-gray-600 text-sm break-words mt-1">${route.holds.join(', ')}</p>
                        `;
                        routeDetails.appendChild(detailDiv);
                    }
                });
            }

            function updateUI() {
                renderControls();
                renderWall();
                renderDetails();
            }

            function loadRoutes(jsonString, fromDropdown = false) {
                try {
                    const data = JSON.parse(jsonString);
                    if (!Array.isArray(data)) throw new Error("JSON数据必须是一个数组。");
                    
                    data.forEach(route => {
                        if (!route.routeName || !route.color || !Array.isArray(route.holds)) {
                            throw new Error("每个路线对象必须包含 'routeName', 'color', 和 'holds' 数组。");
                        }
                    });

                    routeData = data;
                    activeRoutes.clear();
                    routeData.forEach((_, index) => activeRoutes.add(index));
                    errorMessage.textContent = '';
                    jsonInput.value = JSON.stringify(routeData, null, 2);
                    localStorage.setItem(LAST_VIEWED_KEY, jsonInput.value);
                    if (!fromDropdown) {
                       savedLayoutsDropdown.value = "";
                    }
                    updateUI();
                } catch (e) {
                    errorMessage.textContent = `错误: ${e.message}`;
                    console.error(e);
                }
            }
            
            // --- Initialization and Event Listeners ---
            function initialize() {
                // Initialize axis labels
                const colLabels = document.getElementById('col-labels');
                const rowLabels = document.getElementById('row-labels');
                colLabels.innerHTML = '';
                rowLabels.innerHTML = '';
                for (let i = 0; i < WALL_WIDTH; i++) {
                    colLabels.innerHTML += `<div>${String.fromCharCode('A'.charCodeAt(0) + i)}</div>`;
                }
                for (let i = 1; i <= WALL_HEIGHT; i++) {
                    const label = document.createElement('div');
                    label.className = 'flex-1 flex items-center justify-center';
                    label.textContent = i;
                    rowLabels.appendChild(label);
                }

                // Populate dropdown
                populateLayoutsDropdown();

                // Event Listeners
                updateBtn.addEventListener('click', () => loadRoutes(jsonInput.value));
                saveBtn.addEventListener('click', handleSaveLayout);
                deleteLayoutBtn.addEventListener('click', handleDeleteLayout);
                savedLayoutsDropdown.addEventListener('change', (e) => {
                    const layoutName = e.target.value;
                    if (layoutName) {
                        const layouts = getSavedLayouts();
                        loadRoutes(layouts[layoutName], true);
                    }
                });

                // Initial Load
                const lastViewed = localStorage.getItem(LAST_VIEWED_KEY);
                loadRoutes(lastViewed || initialJsonData);
            }

            initialize();
        });
    </script>
</body>
</html>
